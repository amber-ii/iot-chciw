<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自來水</title>
    <link rel="stylesheet" type="text/css" href="./css/water.css">
    <link rel="stylesheet" type="text/css" href="./css/index.css">
    <link rel="stylesheet" type="text/css" href="./css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="./css/progress.css">
    <link rel="stylesheet" type="text/css" href="./css/pattern.css">

    <link rel="stylesheet" href="./css/style.css">
    <link rel="icon" href="http://web.chciw.com.tw/iot-chciw/favicon.ico" width="32px" type="image/x-icon">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp" rel="stylesheet">
</head>

<body onload="subTopic='WaterProj';MQTTConnect();">
    <!-- 修改SV的提示ok -->
    <div class="loadingSv unblock">
        <div class="flex items-center justify-center sticky top-0 w-full h-6 bg-red-400 text-gray-100">提交中...</div>
    </div>

    <!-- 這裡要放查詢報表的提示，再來的loading  ok -->
    <section>
        <div class="loading flex items-center justify-center fixed left-0 bottom-0 w-full h-full">
            <div class="relative">
                <div class="load-circle"></div>
                <div class="word absolute top-0">loading</div>
            </div>
        </div>

    </section>


    <!-- 即時資訊 -->
    <section class="text-gray-200">
        <div class=" max-w-full mx-auto pb-10 px-14">
            <div class="flex flex-wrap justify-center pt-10 sm:-m-4 -mx-4 -mb-10 -mt-4 animate__animated animate__fadeIn">
                <div class="flex justify-center mb-20">
                    <div class="flex items-center pl-20 mt-10">
                        <div class="image">
                            <!-- <img class="image__img" src="https://img.icons8.com/color/48/000000/pumphouse.png" /> -->
                            <img class="image__img mb-4" src="https://img.icons8.com/fluency/96/000000/pumphouse.png" />
                            <div class="image__overlay image__overlay--primary">
                                <p class="image__description">
                                    點我切換機台
                                </p>
                            </div>
                        </div>
                        <div class="line1"></div>
                        <div class="line2"></div>
                        <div class="flex flex-col">
                            <div class="inv1">
                                <div class="grid grid-cols-3 fqCard">
                                    <div class="space-y-3 flex  items-center flex-col">
                                        <div class="flex space-x-2 items-center">
                                            <ion-icon name="barcode-outline" class="icon-item"></ion-icon>
                                            <span class="text-xl">ST1</span>
                                        </div>
                                        <span id="St1" class="fqvalue">0</span>
                                    </div>

                                    <div class="space-y-3 flex  items-center flex-col">
                                        <div class="flex space-x-2 items-center">
                                            <ion-icon name="toggle" class="icon-item"></ion-icon>
                                            <span class="text-xl ">SW1</span>
                                        </div>
                                        <span id="Sw1" class="fqvalue">0</span>
                                    </div>


                                    <div class="space-y-3 flex items-center flex-col">
                                        <div class="flex space-x-2 items-center">
                                            <ion-icon name="timer-outline" class="icon-item"></ion-icon>
                                            <span class="text-xl">FQ1</span>
                                        </div>
                                        <span id="Fq1" class="fqvalue">0</span>
                                    </div>
                                </div>
                            </div>

                            <div class="line3 relative">

                                <div class="absolute">
                                    <iframe src="./watererr.html" scroll="none" width="1000px" height="300px" id="iframe"></iframe>
                                </div>
                            </div>

                            <div class="block1 text-center text-2xl  pt-2">
                                <div id="motor1" class="motor-none">
                                    <ion-icon name="settings" size="large"></ion-icon>
                                </div>
                            </div>

                            <div class="line4 "></div>
                            <div class="block2 text-center text-2xl  pt-2">
                                <div id="motor2" class="motor-none">
                                    <ion-icon name="settings" size="large"></ion-icon>
                                </div>
                            </div>


                            <div class="inv2">
                                <div class="grid grid-cols-3 fqCard">
                                    <div class="space-y-3 flex items-center flex-col">
                                        <div class="flex space-x-2 items-center">
                                            <ion-icon name="barcode-outline" class="icon-item"></ion-icon>
                                            <span class="text-xl ">ST2</span>
                                        </div>
                                        <span id="St2" class="fqvalue">0</span>
                                    </div>

                                    <div class="space-y-3 flex  items-center flex-col">
                                        <div class="flex space-x-2 items-center">
                                            <ion-icon name="toggle" class="icon-item"></ion-icon>
                                            <span class="text-xl ">SW2</span>
                                        </div>
                                        <span id="Sw2" class="fqvalue">0</span>
                                    </div>


                                    <div class="space-y-3 flex  items-center flex-col">
                                        <div class="flex space-x-2 items-center">
                                            <ion-icon name="timer-outline" id="timer2" class="icon-item"></ion-icon>
                                            <span class="text-xl ">FQ2</span>
                                        </div>
                                        <span id="Fq2" class="fqvalue">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="line5"></div>
                        <div class="line6"></div>
                        <div class="pand7 flex flex-col justify-center items-center">
                            <div>
                                <div class="flex items-center name pb-1">
                                    <h5>Press</h5>
                                    <div class="text-xs">---<sup>kgf</sup><sub>/cm</sub>
                                        <sup>2</sup>
                                    </div>
                                </div>
                                <div class="press-dot1">
                                    <div class="press-dot2 text-center">
                                        <span id="Press" class="pressvalue">2</span>
                                    </div>
                                    <div class="transform translate-x-32  translate-y-8 ">
                                        <div class="flex flex-row border h-10 w-28 rounded-lg border-gray-400 relative">
                                            <input type="text" id="modPress" class="text-center text-gray-800 font-semibold border-r border-gray-400 h-full w-16 flex rounded-l" readonly/>

                                            <button id="submitPressBtn" class="font-semibold border-l hover:bg-red-500  border-gray-400 h-full w-20 flex rounded-r focus:outline-none cursor-not-allowed">
                                                <span
                                                    class="m-auto font-light text-green-500 hover:text-white">提交</span>
                                            </button>


                                            <div class="absolute flex flex-col p-2 w-32 md:w-full mt-6 md:mt-8 mt-10 flex items-start justify-center transform -translate-x-5 hover:scale-110">
                                                <svg width="10" height="10" class="fill-current ml-5 md:mx-auto">
                                                    <polygon points="0 10, 10 10, 5 0" />
                                                </svg>
                                                <div class="text-sm block w-64 flex flex-wrap justify-center bg-black p-1 h-auto rounded-lg text-gray-100">調整壓力，目前設定值:<span id="SV" class="pl-2 font-bold text-md text-white mr-3"></span>
                                                    <div class="text-xs text-gray-400"><sup>kgf</sup><sub>/cm</sub>
                                                        <sup class="-ml-1">2</sup>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="">
                                <img src="https://img.icons8.com/external-itim2101-blue-itim2101/50/000000/external-pipeline-plumber-tools-itim2101-blue-itim2101-5.png" />
                            </div> -->
                        </div>
                        <!-- <div class="line8"></div> -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!--趨勢圖 ok -->
    <div class="bg-gray-900 flex items-center justify-center mb-6">
        <div class="bg-gray-800 text-gray-100 rounded shadow-xl py-5 px-5 w-full lg:w-11/12" x-data="{chartData:chartData()}" x-init="chartData.fetch()">
            <div class="flex flex-wrap items-end">
                <div class="flex-1 mb-5 flex inline-block">
                    <h3 class="text-lg font-semibold leading-tight">自來水節電量</h3>
                    <span class="text-sm leading-tight text-gray-400 ml-2 pt-1">單位:度</span>
                </div>
                <div class="relative mb-5 " @click.away="chartData.showDropdown=false">
                    <button class="text-md hover:text-gray-300 h-6 focus:outline-none" @click="chartData.showDropdown=!chartData.showDropdown">
                <span x-text="chartData.options[chartData.selectedOption].label"></span><i
                  class="ml-1 mdi mdi-chevron-down"></i><ion-icon name="chevron-down-outline"></ion-icon>
              </button>
                    <div class="bg-gray-700  shadow-lg rounded text-sm absolute top-auto right-0 min-w-full w-32 z-30 mt-1 -mr-3" x-show="chartData.showDropdown" style="display: none;" x-transition:enter="transition ease duration-300 transform" x-transition:enter-start="opacity-0 translate-y-2"
                        x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease duration-300 transform" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 translate-y-4">
                        <span class="absolute top-0 right-0 w-3 h-3 bg-gray-700 transform rotate-45 -mt-1 mr-3"></span>
                        <div class="bg-gray-700 rounded w-full relative z-10 py-1 ">
                            <ul class="list-reset text-xs ">

                                <template x-for="(item,index) in chartData.options">
                      <li
                        class="px-4 py-2 hover:bg-gray-600 hover:text-white transition-colors duration-100 cursor-pointer "
                        :class="{'text-white':index==chartData.selectedOption}"
                        @click="chartData.selectOption(index);chartData.showDropdown=false">
                        <span x-text="item.label"></span>
                      </li>
                    </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <canvas id="chart" class="w-full"></canvas>
            </div>
        </div>
    </div>

    <!-- 搜尋欄 -->
    <div class="bg-gray-900 flex justify-center text-gray-200 mt-10">
        <div class="flex w-full lg:w-11/12">
            <form id="form1" name="dateSearch">
                <div class="flex space-x-6">
                    <div class="flex items-center space-x-2 border-r-2 border-gray-300 pr-6">
                        <label for="startDate">起始日</label>
                        <input type="date" name="startDate" id="startDate" class="text-gray-700 text-center rounded-lg">
                    </div>
                    <div class="flex items-center space-x-2 border-r-2 border-gray-400 pr-6">
                        <label for="endDate">結束日</label>
                        <input type="date" name="endDate" id="endDate" class="text-gray-700 text-center rounded-lg">
                    </div>
                    <div class="flex items-center space-x-2 border-r-2 border-gray-700 pr-6">
                        <div title="查詢" id="search" class="">
                            <img src="https://img.icons8.com/external-prettycons-flat-prettycons/47/000000/external-search-essentials-prettycons-flat-prettycons-3.png" />
                        </div>
                    </div>
                    <div title="導出報表" class="flex items-center space-x-2 border-r-2 border-gray-700 pr-6">
                        <button id="btnExport" class="download" onclick="exportTable();return false">
                         <img src="https://img.icons8.com/doodle/48/000000/microsoft-excel-2019.png"/>
                        </button>
                    </div>
                </div>
            </form>
            <div class="flex items-center border-l-2 border-green-700 pl-4 space-x-2 ml-auto mr-1" style="font-family: 'cwTeXYen';">
                此次搜尋的總節電量：<span id="saveresult" class="mx-3"></span>
                <div class="ml-auto" style="font-family: 'cwTeXYen';">度</div>
            </div>
        </div>
    </div>
    <!-- 表格 -->
    <section class="tables lg:w-11/12">
        <table class="w-full" id="headerTable">
            <thead class="sticky top-0">
                <tr class="">
                    <th>日期</th>
                    <th>Press</th>
                    <th>Sp1</th>
                    <th>Sp2</th>
                    <th>節電量</th>
                </tr>
            </thead>
            <tbody class="" id="table2">

            </tbody>
        </table>
    </section>

</body>


<script>
    $('.loading').hide();
    $('.word').hide()


    var roundDecimal = function(val, precision) {
        return Math.round(Math.round(val * Math.pow(10, (precision || 0) + 1)) / 10) / Math.pow(10, (precision || 0));
    }
    Number.prototype.comma_formatter = function() {
        return this.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ',')
    }

    function onMessageArrived(r_message) {
        var rcMsg = JSON.parse(r_message.payloadString);
        for (var key in rcMsg) {
            var waterId = key;
            var waterValue = rcMsg[key];
            if (document.getElementById(waterId)) {
                document.getElementById(waterId).innerHTML = waterValue;

                if (document.getElementById('Sw1').innerHTML == 1) {
                    document.querySelector('#motor1').classList.add('motor-run')
                    document.querySelector('#motor1').classList.remove('motor-none')
                }
                if (document.getElementById('Sw1').innerHTML == 0) {
                    document.querySelector('#motor1').classList.remove('motor-run')
                    document.querySelector('#motor1').classList.add('motor-none')
                }
                if (document.getElementById('Sw2').innerHTML == 1) {
                    document.querySelector('#motor2').classList.add('motor-run')
                    document.querySelector('#motor2').classList.remove('motor-none')
                }
                if (document.getElementById('Sw2').innerHTML == 0) {
                    document.querySelector('#motor2').classList.remove('motor-run')
                    document.querySelector('#motor2').classList.add('motor-none')
                }
            }
        }
    }



    // 趨勢圖
    let chartData = function() {
        return {
            date: '7days',
            options: [{
                    label: 'Last 7 Days',
                    value: '7days',
                }, {
                    label: 'Last 30 Days',
                    value: '30days',
                }, {
                    label: 'Last 6 Months',
                    value: '6months',
                }, {
                    label: 'Last 12 Months',
                    value: '12months',
                },

            ],
            showDropdown: false,
            selectedOption: 0,
            selectOption: function(index) {
                this.selectedOption = index
                this.date = this.options[index].value
                this.renderChart()
            },
            data: null,
            fetch: function() {
                fetch("http://localhost:8080/waters/chart")
                    .then((res) => res.json())
                    .then((res) => {
                        this.data = res.dates
                        this.renderChart()
                    })
            },
            renderChart: function() {
                let c = false
                    // eslint-disable-next-line
                Chart.helpers.each(Chart.instances, function(instance) {
                    if (instance.chart.canvas.id == 'chart') {
                        c = instance
                    }
                })

                if (c) {
                    c.destroy()
                }

                let ctx = document.getElementById('chart').getContext('2d')
                    // eslint-disable-next-line
                let chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.data[this.date].data.label,
                        datasets: [{
                            label: '節電量',
                            borderColor: 'rgba(30,144,225, 1)',
                            pointBackgroundColor: 'rgba(30,144,225, 1)',
                            data: this.data[this.date].data.SaveAmount,
                        }],
                    },
                    layout: {
                        padding: {
                            right: 10,
                        },
                    },
                    options: {
                        legend: {
                            display: true,
                            labels: {
                                // 點選的標題大小
                                fontSize: 17,
                            },
                        },

                        scales: {
                            yAxes: [{
                                gridLines: {
                                    display: false,
                                },
                                ticks: {
                                    fontSize: 16,
                                    // eslint-disable-next-line
                                    callback: function(value, index, array) {
                                        return value > 1000 ? (value < 1000000 ? value / 1000 + 'K' : value / 1000000 + 'M') : value
                                    },
                                },
                            }, ],
                            xAxes: [{
                                gridLines: {
                                    display: false,
                                },
                                ticks: {
                                    fontSize: 16,
                                },
                            }, ],
                        },
                    },
                })
            },
        }
    }

    var DateDiff = function(a, b) {
        var oDate1 = new Date(a)
        var oDate2 = new Date(b)
        var iDays = parseInt(Math.abs(oDate1 - oDate2) / 1000 / 60 / 60 / 24) // 把相差的毫秒數轉換為天數
        return iDays
    }

    function formatDate(now) {
        let date = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate()
        return date
    }




    // 依照日期搜尋
    $('#search').click(function() {
        var t2 = document.getElementById('table2')
        var today = formatDate(new Date()).replace(/(\:|-|\s)(\d)(?=\D|$)/g, '$10$2') // eslint-disable-line

        $.ajax({
            beforeSend: function() {
                var startDate = dateSearch.startDate.value // eslint-disable-line
                var endDate = dateSearch.endDate.value // eslint-disable-line

                if (startDate > endDate) {
                    alert('無效日期，起始日不得大於結束日')
                    return false
                }
                if (!startDate || !endDate) {
                    alert('請輸入起始&結束日')
                    return false
                }
                // if (DateDiff(startDate, endDate) >= 360) {
                //     alert('搜尋日期區間360天')
                //     return false
                // } 
                if (startDate < '2020-07-09') {
                    alert('最早的資料為2020-07-09，請重新搜尋')
                    return false
                }
                if (endDate > today || startDate > today) {
                    alert('日期不得超過今日，請重新搜尋')
                    return false
                }
                $('.loading').show()
                $('.word').show()
                t2.innerHTML = ''
            },
            type: 'POST',
            url: '/waters',
            data: $('#form1').serialize(), //序列化表單的值
            async: true,
            success: function(data) {
                var renderString = ''
                let saveTotal = 0
                for (let index = 0; index < data.length; index++) {
                    renderString =
                        ' <tr>' +
                        '<th>' +
                        data[index].Date +
                        '</th>' +
                        '<th>' +
                        data[index].Press +
                        '</th>' +
                        ' <th>' +
                        data[index].I1sp +
                        '</th>' +
                        ' <th>' +
                        data[index].I2sp +
                        '</th>' +
                        ' <th>' +
                        data[index].SaveAmount +
                        '</th>' +
                        '</tr>'
                    $('#table2').nextAll().remove()
                    t2.insertAdjacentHTML('beforeEnd', renderString)
                    saveTotal += data[index].SaveAmount
                }
                document.querySelector('#saveresult').innerHTML = roundDecimal(saveTotal, 2)
                $('.loading').fadeOut(500)
                $('.word').fadeOut(500)
            },
            error: function(request) {
                alert('資料庫連線失敗，請洽電控組')
            },
        })
    })

    // 導出報表
    function exportTable() {
        // eslint
        var startDate = form1.startDate.value // eslint-disable-line
        var endDate = form1.endDate.value // eslint-disable-line
        var today = new Date()
        var yesterday = new Date((today / 1000 - 86400) * 1000)

        if (!startDate && !endDate) {
            endDate = formatDate(today)
            startDate = formatDate(new Date((today / 1000 - 518400) * 1000))
        }
        $('#headerTable').table2excel({
            name: 'Excel Document Name',
            filename: `自來水節電量[${startDate}]-[${endDate}].xls`,
        })
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.rawgit.com/rainabba/jquery-table2excel/1.1.0/dist/jquery.table2excel.min.js"></script>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

<script type="text/javascript" src="./index.js"></script>
<script type="text/javascript" src="./mqtt.js"></script>
<!-- <script type="text/javascript" src="./views/index"></script> -->
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" defer></script>



</html>
